# ==============================================================================
# Keycloak SSO - OCI Staging Environment
# ==============================================================================
# Configuration for OCI deployment with:
#   - External OCI Autonomous Database (ATP) - PostgreSQL protocol mode
#   - OCI Vault for admin/client secrets (consolidated 'keycloak' secret)
#   - Let's Encrypt TLS via Cloudflare DNS01
# ==============================================================================

keycloak:
  production: true
  replicaCount: 2  # HA configuration for staging
  
  # Distributed cache for multi-replica deployment
  cache:
    enabled: true
    stackName: ""
    stackFile: ""
  
  # ------------------------------------------------------------------------------
  # Admin Credentials from OCI Vault (keycloak secret)
  # ------------------------------------------------------------------------------
  auth:
    adminUser: ""  # Using KC_BOOTSTRAP_ADMIN_USERNAME instead
    existingSecret: keycloak-admin-credentials
    passwordSecretKey: admin-password
  
  # Inject admin credentials from secret via extraEnvVars
  extraEnvVars:
    - name: KEYCLOAK_EXTRA_ARGS
      value: "--features=token-exchange,admin-fine-grained-authz"
    - name: KC_BOOTSTRAP_ADMIN_USERNAME
      valueFrom:
        secretKeyRef:
          name: keycloak-admin-credentials
          key: admin-user
    - name: KC_BOOTSTRAP_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-admin-credentials
          key: admin-password
    # Database driver selection (Oracle with wallet or PostgreSQL protocol)
    - name: KC_DB
      value: "oracle"  # Using native Oracle JDBC driver with wallet
    # Oracle schema configuration (no PUBLIC schema prefix in Oracle)
    - name: KC_DB_SCHEMA
      value: "KEYCLOAK"
    # Oracle Net TNS_ADMIN for wallet location
    - name: JAVA_OPTS_APPEND
      value: "-Doracle.net.tns_admin=/opt/oracle/wallet"
    # Full JDBC URL from secret
    - name: KC_DB_URL
      valueFrom:
        secretKeyRef:
          name: keycloak-postgres-credentials
          key: jdbc-url
    - name: KC_DB_USERNAME
      valueFrom:
        secretKeyRef:
          name: keycloak-postgres-credentials
          key: username
    - name: KC_DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: keycloak-postgres-credentials
          key: password
    # TNS_ADMIN points to extracted wallet directory
    - name: TNS_ADMIN
      value: "/opt/oracle/wallet"
  
  # Copy Oracle JARs to providers directory at startup
  lifecycleHooks:
    postStart:
      exec:
        command:
          - /bin/bash
          - -c
          - |
            echo "Copying Oracle JDBC drivers and security libraries to providers directory..."
            cp -v /tmp/oracle-jars/*.jar /opt/bitnami/keycloak/providers/
            echo "Oracle libraries copied successfully"
            ls -lh /opt/bitnami/keycloak/providers/
  
  # ------------------------------------------------------------------------------
  # Oracle JDBC Driver and Wallet InitContainers
  # ------------------------------------------------------------------------------
  initContainers:
    # Download Oracle JDBC driver (not included in Bitnami image)
    - name: install-oracle-driver
      image: docker.io/curlimages/curl:8.5.0
      command:
        - sh
        - -c
        - |
          set -e
          echo "Downloading Oracle JDBC driver and security libraries..."
          # Download ojdbc11 from Maven Central (Oracle 21c driver, compatible with ATP)
          curl -L -o /providers/ojdbc11.jar \
            https://repo1.maven.org/maven2/com/oracle/database/jdbc/ojdbc11/23.3.0.23.09/ojdbc11-23.3.0.23.09.jar
          # Download oraclepki.jar (required for SSO wallet support)
          curl -L -o /providers/oraclepki.jar \
            https://repo1.maven.org/maven2/com/oracle/database/security/oraclepki/21.9.0.0/oraclepki-21.9.0.0.jar
          # Download osdt_core.jar (required for SSO wallet support)
          curl -L -o /providers/osdt_core.jar \
            https://repo1.maven.org/maven2/com/oracle/database/security/osdt_core/21.9.0.0/osdt_core-21.9.0.0.jar
          # Download osdt_cert.jar (required for SSL certificate handling)
          curl -L -o /providers/osdt_cert.jar \
            https://repo1.maven.org/maven2/com/oracle/database/security/osdt_cert/21.9.0.0/osdt_cert-21.9.0.0.jar
          echo "Oracle libraries installed successfully"
          ls -lh /providers/
      volumeMounts:
        - name: app-providers-dir
          mountPath: /providers
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
    
    # Download wallet from OCI Object Storage using instance principal
    - name: download-wallet
      image: ghcr.io/oracle/oci-cli:latest
      command:
        - sh
        - -c
        - |
          set -e
          echo "Downloading ATP wallet from Object Storage..."
          # Configure OCI CLI for instance principal auth
          export OCI_CLI_AUTH=instance_principal
          # Read bucket info from secret
          BUCKET_NAME=$(cat /bucket-info/bucket_name)
          NAMESPACE=$(cat /bucket-info/namespace)
          OBJECT_NAME=$(cat /bucket-info/object_name)
          REGION=$(cat /bucket-info/region)
          
          # Download wallet.zip
          oci os object get \
            --namespace "$NAMESPACE" \
            --bucket-name "$BUCKET_NAME" \
            --name "$OBJECT_NAME" \
            --file /wallet-download/wallet.zip \
            --region "$REGION" \
            --auth instance_principal
          
          echo "Wallet downloaded successfully"
          ls -lh /wallet-download/
      volumeMounts:
        - name: wallet-bucket-info
          mountPath: /bucket-info
          readOnly: true
        - name: wallet-download
          mountPath: /wallet-download
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
    
    # Extract wallet.zip to /wallet directory
    - name: extract-wallet
      image: busybox:1.36
      command:
        - sh
        - -c
        - |
          set -e
          echo "Extracting ATP wallet..."
          mkdir -p /wallet
          # ATP wallets downloaded via API don't require password for extraction
          unzip -o /wallet-download/wallet.zip -d /wallet
          # Update sqlnet.ora with absolute wallet path for Oracle JDBC
          sed -i 's|DIRECTORY="?/network/admin"|DIRECTORY="/opt/oracle/wallet"|g' /wallet/sqlnet.ora
          echo "Wallet extracted and configured successfully"
          cat /wallet/sqlnet.ora
          ls -la /wallet/
      volumeMounts:
        - name: wallet-download
          mountPath: /wallet-download
          readOnly: true
        - name: wallet-dir
          mountPath: /wallet
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
  
  # Mount providers and wallet to main container
  extraVolumeMounts:
    - name: app-providers-dir
      mountPath: /tmp/oracle-jars
      readOnly: true
    - name: wallet-dir
      mountPath: /opt/oracle/wallet
      readOnly: true
  
  extraVolumes:
    # EmptyDir for Oracle libraries (shared between init and main container)
    - name: app-providers-dir
      emptyDir: {}
    # Bucket info from ExternalSecret
    - name: wallet-bucket-info
      secret:
        secretName: keycloak-wallet-bucket-info
        defaultMode: 0400
    # EmptyDir for downloaded wallet.zip
    - name: wallet-download
      emptyDir: {}
    # EmptyDir for extracted wallet
    - name: wallet-dir
      emptyDir: {}
  
  # ------------------------------------------------------------------------------
  # Disable in-cluster PostgreSQL - Using external OCI ATP
  # ------------------------------------------------------------------------------
  postgresql:
    enabled: false
  
  # External database configuration (OCI Autonomous Database - PostgreSQL protocol)
  externalDatabase:
    host: "adb.il-jerusalem-1.oraclecloud.com"
    port: 1521
    database: stagingdb_high
    existingSecret: "keycloak-postgres-credentials"
    existingSecretPasswordKey: "password"
    existingSecretUserKey: "username"
  
  # TLS/Proxy configuration for production mode
  proxyHeaders: xforwarded
  
  # ------------------------------------------------------------------------------
  # Ingress Configuration
  # ------------------------------------------------------------------------------
  ingress:
    enabled: true
    ingressClassName: nginx
    # UPDATE: Set your actual domain
    hostname: keycloak.adaas-il.com
    tls: true
    annotations:
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    extraTls:
      - hosts:
          - keycloak.adaas-il.com
        secretName: keycloak-tls
  
  # ------------------------------------------------------------------------------
  # Resources - Sized for OCI Always-Free tier
  # ------------------------------------------------------------------------------
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi

# ------------------------------------------------------------------------------
# External Secrets - OCI Vault
# ------------------------------------------------------------------------------
externalSecrets:
  enabled: true
  refreshInterval: "10m"
  secretStore:
    name: oci-vault
    kind: ClusterSecretStore
  # Consolidated OCI Vault secret name (matches Terraform application_secrets key)
  appSecretKey: "keycloak"

# ------------------------------------------------------------------------------
# Database Wallet Configuration (ATP mTLS)
# ------------------------------------------------------------------------------
database:
  wallet:
    enabled: true
    refreshInterval: "24h"
    # TNS alias from tnsnames.ora (extracted from wallet)
    tnsAlias: "stagingdb_high"
