{{- if .Values.argocd.oidc.enabled }}
# ==============================================================================
# ArgoCD OIDC ConfigMap
# ==============================================================================
# This ConfigMap contains the OIDC configuration for ArgoCD
# Apply to ArgoCD by patching argocd-cm ConfigMap
# ==============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
    app.kubernetes.io/part-of: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
data:
  # Base URL for ArgoCD (used for redirect URIs)
  url: "https://platform.staging.local/argo"
  # OIDC configuration for Keycloak SSO
  oidc.config: |
    name: Keycloak
    issuer: {{ .Values.argocd.oidc.issuer }}
    clientID: {{ .Values.argocd.oidc.clientId }}
    clientSecret: $oidc.keycloak.clientSecret
    requestedScopes:
      - openid
      - profile
      - email
      - groups
    requestedIDTokenClaims:
      groups:
        essential: true
---
# ==============================================================================
# ArgoCD RBAC ConfigMap
# ==============================================================================
# Maps Keycloak groups to ArgoCD roles
# ==============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: argocd
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
    app.kubernetes.io/part-of: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
data:
  # Keycloak group to ArgoCD role mappings
  policy.csv: |
    # Platform admins get full admin access
    g, /platform-admins, role:admin
    
    # Developers get read access plus sync/logs
    g, /developers, role:readonly
    p, role:developer, applications, sync, */*, allow
    p, role:developer, applications, get, */*, allow
    p, role:developer, logs, get, */*, allow
    g, /developers, role:developer
  
  # Default policy for authenticated users
  policy.default: role:readonly
  
  # Use groups claim from OIDC token
  scopes: '[groups]'
---
# ==============================================================================
# ArgoCD Secret for OIDC Client Secret
# ==============================================================================
# ExternalSecret to fetch ArgoCD OIDC client secret from AWS Secrets Manager
# ==============================================================================
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-oidc-secret
  namespace: argocd
  labels:
    {{- include "keycloak.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  refreshInterval: "5m"
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: argocd-secret
    creationPolicy: Merge
    template:
      type: Opaque
      data:
        # ArgoCD expects the client secret in this specific key
        oidc.keycloak.clientSecret: "{{ `{{ .clientSecret }}` }}"
  data:
    - secretKey: clientSecret
      remoteRef:
        key: {{ .Values.externalSecrets.clientSecrets.remoteRef | default "staging/keycloak/clients" }}
        property: argocd-secret
{{- end }}
