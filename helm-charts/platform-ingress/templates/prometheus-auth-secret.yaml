# ==============================================================================
# Prometheus Basic Auth Secret
# ==============================================================================
{{- if and .Values.prometheus.enabled .Values.prometheus.basicAuth.enabled }}
{{- $password := .Values.prometheus.basicAuth.password | default (randAlphaNum 24) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.prometheus.basicAuth.secretName }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "platform-ingress.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
type: Opaque
data:
  # htpasswd format: username:password_hash
  # Using bcrypt hash for nginx basic auth
  auth: {{ htpasswd .Values.prometheus.basicAuth.username $password | b64enc }}
---
# Store credentials in a readable secret for reference
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.prometheus.basicAuth.secretName }}-credentials
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "platform-ingress.labels" . | nindent 4 }}
  annotations:
    argocd.argoproj.io/sync-wave: "1"
    description: "Prometheus basic auth credentials (for reference)"
type: Opaque
stringData:
  username: {{ .Values.prometheus.basicAuth.username }}
  password: {{ $password }}
{{- end }}
