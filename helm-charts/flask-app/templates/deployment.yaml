apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "flask-app.fullname" . }}
  labels:
    {{- include "flask-app.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  selector:
    matchLabels:
      {{- include "flask-app.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        {{- if .Values.monitoring.enabled }}
        prometheus.io/scrape: "true"
        prometheus.io/port: "5000"
        prometheus.io/path: "/metrics"
        {{- end }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- if .Values.rotation.reloader.enabled }}
        # Stakater Reloader annotations for automatic pod restart on secret changes
        {{- if .Values.rotation.reloader.autoRestart }}
        reloader.stakater.com/auto: "true"
        {{- else }}
        reloader.stakater.com/search: "true"
        secret.reloader.stakater.com/reload: "{{ include "flask-app.fullname" . }}-jwt-keys,{{ .Values.secretNames.databaseCredentials }}"
        {{- end }}
      {{- end }}
      labels:
        {{- include "flask-app.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "flask-app.serviceAccountName" . }}
      {{- with .Values.podSecurityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.database.wallet.enabled }}
      # Wallet Download and Extraction InitContainers
      initContainers:
        # Download wallet from OCI Object Storage using instance principal
        - name: download-wallet
          image: ghcr.io/oracle/oci-cli:latest
          command:
            - sh
            - -c
            - |
              set -e
              echo "Downloading ATP wallet from Object Storage..."
              # Configure OCI CLI for instance principal auth
              export OCI_CLI_AUTH=instance_principal
              # Read bucket info from secret
              BUCKET_NAME=$(cat /bucket-info/bucket_name)
              NAMESPACE=$(cat /bucket-info/namespace)
              OBJECT_NAME=$(cat /bucket-info/object_name)
              REGION=$(cat /bucket-info/region)
              
              # Download wallet.zip
              oci os object get \
                --namespace "$NAMESPACE" \
                --bucket-name "$BUCKET_NAME" \
                --name "$OBJECT_NAME" \
                --file /wallet-download/wallet.zip \
                --region "$REGION" \
                --auth instance_principal
              
              echo "Wallet downloaded successfully"
              ls -lh /wallet-download/
          volumeMounts:
            - name: wallet-bucket-info
              mountPath: /bucket-info
              readOnly: true
            - name: wallet-download
              mountPath: /wallet-download
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
        
        # Extract wallet.zip to /wallet directory
        - name: extract-wallet
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -e
              echo "Extracting ATP wallet..."
              mkdir -p /wallet
              # ATP wallets downloaded via API don't require password for extraction
              unzip -o /wallet-download/wallet.zip -d /wallet
              echo "Wallet extracted successfully"
              ls -la /wallet/
          volumeMounts:
            - name: wallet-download
              mountPath: /wallet-download
              readOnly: true
            - name: wallet-dir
              mountPath: /wallet
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort }}
              protocol: TCP
          envFrom:
            - configMapRef:
                name: {{ include "flask-app.fullname" . }}-config
          {{- if .Values.secretNames.databaseCredentials  }}
            - secretRef:
                name: {{ .Values.secretNames.databaseCredentials }}
          {{- end }}
          {{- if .Values.secretNames.flaskSecret }}
            - secretRef:
                name: {{ .Values.secretNames.flaskSecret }}
          {{- end }}
          {{- if .Values.secretNames.adminCredentials }}
            - secretRef:
                name: {{ .Values.secretNames.adminCredentials }}
          {{- end }}  
          env:
              {{- if .Values.jwt.enabled }}
            - name: JWT_ALGORITHM
              value: {{ .Values.jwt.algorithm | quote }}
            - name: JWT_ISSUER
              value: {{ .Values.jwt.issuer | quote }}
            - name: JWT_AUDIENCE
              value: {{ .Values.jwt.audience | quote }}
            - name: JWT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.jwt.existingSecret }}
                  key: {{ .Values.jwt.privateKeyKey }}
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.jwt.existingSecret }}
                  key: {{ .Values.jwt.publicKeyKey }}
              {{- end }}
              {{- if .Values.oidc.enabled }}
            # OIDC/Keycloak Configuration
            - name: OIDC_ENABLED
              value: "true"
            - name: OIDC_ISSUER
              value: {{ .Values.oidc.issuer | quote }}
            - name: OIDC_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: {{ default (printf "%s-oidc" (include "flask-app.fullname" .)) .Values.oidc.existingSecret }}
                  key: OIDC_CLIENT_ID
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ default (printf "%s-oidc" (include "flask-app.fullname" .)) .Values.oidc.existingSecret }}
                  key: OIDC_CLIENT_SECRET
            - name: OIDC_SCOPES
              value: {{ .Values.oidc.scopes | quote }}
            - name: OIDC_AUDIENCE
              value: {{ .Values.oidc.audience | quote }}
            - name: OIDC_ALGORITHMS
              value: {{ .Values.oidc.algorithms | join "," | quote }}
            - name: OIDC_GROUPS_CLAIM
              value: {{ .Values.oidc.groupsClaim | quote }}
              {{- end }}
              {{- if .Values.bff.enabled }}
            # ================================================================
            # BFF (Backend-for-Frontend) Authentication Mode
            # ================================================================
            - name: AUTH_MODE
              value: "bff"
            - name: BFF_INTERNAL_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.bff.internalSecretRef.name | quote }}
                  key: {{ .Values.bff.internalSecretRef.key | quote }}
            - name: BFF_INTERNAL_SECRET_HEADER
              value: {{ .Values.bff.headers.internalAuth | quote }}
            - name: BFF_HEADER_SUB
              value: {{ .Values.bff.headers.sub | quote }}
            - name: BFF_HEADER_EMAIL
              value: {{ .Values.bff.headers.email | quote }}
            - name: BFF_HEADER_USERNAME
              value: {{ .Values.bff.headers.username | quote }}
            - name: BFF_HEADER_GROUPS
              value: {{ .Values.bff.headers.groups | quote }}
            - name: BFF_TOKEN_HEADER
              value: {{ .Values.bff.headers.token | quote }}
            - name: BFF_VALIDATE_JWT
              value: {{ .Values.bff.validateJwt | quote }}
            - name: BFF_JIT_PROVISION
              value: {{ .Values.bff.jitProvision | quote }}
            - name: BFF_ROLES_SOURCE
              value: {{ .Values.bff.rolesSource | quote }}
            - name: CSRF_ENABLED
              value: {{ .Values.bff.csrf.enabled | quote }}
            - name: CSRF_COOKIE_NAME
              value: {{ .Values.bff.csrf.cookieName | quote }}
            - name: CSRF_HEADER_NAME
              value: {{ .Values.bff.csrf.headerName | quote }}
              {{- end }}
            {{- if .Values.database.wallet.enabled }}
            # ================================================================
            # Oracle ATP Configuration (wallet-based authentication)
            # ================================================================
            # TNS_ADMIN points to extracted wallet directory
            - name: TNS_ADMIN
              value: {{ .Values.database.wallet.mountPath | default "/opt/oracle/wallet" | quote }}
            # Oracle Wallet Directory (required by python-oracledb)
            - name: ORACLE_WALLET_DIR
              value: {{ .Values.database.wallet.mountPath | default "/opt/oracle/wallet" | quote }}
            # Oracle DSN (TNS alias from tnsnames.ora)
            - name: ORACLE_DSN
              value: {{ .Values.database.wallet.tnsAlias | quote }}
            # Oracle credentials from secret
            - name: ORACLE_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secretNames.databaseCredentials }}
                  key: DB_USER
            - name: ORACLE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.secretNames.databaseCredentials }}
                  key: DB_PASSWORD
            # Optional: Oracle connection pool settings
            {{- if .Values.database.wallet.poolMin }}
            - name: ORACLE_POOL_MIN
              value: {{ .Values.database.wallet.poolMin | quote }}
            {{- end }}
            {{- if .Values.database.wallet.poolMax }}
            - name: ORACLE_POOL_MAX
              value: {{ .Values.database.wallet.poolMax | quote }}
            {{- end }}
            {{- if .Values.database.wallet.poolIncrement }}
            - name: ORACLE_POOL_INCREMENT
              value: {{ .Values.database.wallet.poolIncrement | quote }}
            {{- end }}
            {{- end }}
          {{- with .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
          {{- with .Values.volumeMounts }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- if .Values.database.wallet.enabled }}
          # Mount extracted wallet directory
          - name: wallet-dir
            mountPath: {{ .Values.database.wallet.mountPath | default "/opt/oracle/wallet" }}
            readOnly: true
          {{- end }}
          # Mount database encryption keys as directory
          - name: db-encryption-keys
            mountPath: /run/secrets/db_encryption_keys
            readOnly: true
      volumes:
      {{- with .Values.volumes }}
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.database.wallet.enabled }}
      # Bucket info from ExternalSecret
      - name: wallet-bucket-info
        secret:
          secretName: {{ include "flask-app.fullname" . }}-wallet-bucket-info
          defaultMode: 0400
      # EmptyDir for downloaded wallet.zip
      - name: wallet-download
        emptyDir: {}
      # EmptyDir for extracted wallet
      - name: wallet-dir
        emptyDir: {}
      {{- end }}
      # Encryption keys volume (mounted separately for rotation monitoring)
      - name: db-encryption-keys
        projected:
          defaultMode: 0400
          sources:
          - secret:
              name: {{ .Values.secretNames.encryptionKeys | default "flask-app-encryption-keys" }}
              items:
              {{- if .Values.rotation.database.keyVersions }}
              {{- range .Values.rotation.database.keyVersions }}
              - key: db_encryption_{{ . }}.key
                path: {{ . }}.key
              {{- end }}
              {{- else }}
              # Default to v1 if keyVersions not specified
              - key: db_encryption_v1.key
                path: v1.key
              {{- end }}
              - key: db_encryption_current.version
                path: current.version
              {{- if .Values.rotation.database.enabled }}
              - key: rotation_date
                path: rotation_date
              - key: migration_status
                path: migration_status
              {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
