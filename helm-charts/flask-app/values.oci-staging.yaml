# ==============================================================================
# Flask App - OCI Staging Environment
# ==============================================================================
# Configuration for OCI deployment with:
#   - External OCI Autonomous Database (ATP) - PostgreSQL mode
#   - OCI Vault for secrets management
#   - Wallet-based mTLS connection
#   - Let's Encrypt TLS via Cloudflare DNS01
# ==============================================================================

replicaCount: 2

image:
  tag: "stable-1"

# ------------------------------------------------------------------------------
# Disable in-cluster MySQL - Using external OCI ATP
# ------------------------------------------------------------------------------
db:
  enabled: false

# ------------------------------------------------------------------------------
# Database Configuration - OCI Autonomous Database (PostgreSQL)
# ------------------------------------------------------------------------------
config:
  DEBUG: "0"
  DOCKERIZED: "true"
  GUNICORN_WORKERS: "4"
  BACKEND_PORT: "5000"
  # UPDATE: Set your actual domain
  CORS_ORIGINS: "https://app.adaas-il.com,https://adaas-il.com"
  SQLALCHEMY_TRACK_MODIFICATIONS: "False"
  JWT_ACCESS_TTL: "900"
  JWT_REFRESH_TTL: "2592000"
  JWT_COOKIE_NAME: "rt"
  JWT_CSRF_COOKIE: "csrf_refresh_root"
  JWT_COOKIE_SECURE: "true"
  JWT_COOKIE_SAMESITE: "Lax"
  JWT_COOKIE_DOMAIN: ""
  JWT_LEEWAY: "30"
  API_TEST_MODE: "false"
  DB_FALLBACK_TO_SQLITE_IN_MEMORY: "false"
  # PostgreSQL for OCI ATP
  DB_TYPE: "postgresql"
  # ATP connection info comes from ExternalSecret
  # DB_HOST, DB_PORT, DB_NAME set via secrets
  # Encryption settings
  DB_ENCRYPTION_ENABLED: "true"
  DB_ENCRYPTION_ALGORITHM: "FERNET"
  DB_ENCRYPTION_KEY_ROTATION_GRACE_PERIOD: "86400"
  DATABASE_ENCRYPTION_KEYS_DIR: "/run/secrets/db_encryption_keys"
  DB_ENCRYPTED_FIELDS: "email,phone,medical_notes,patient_name"

# ------------------------------------------------------------------------------
# External Secrets - OCI Vault
# ------------------------------------------------------------------------------
externalSecrets:
  enabled: true
  secretStoreRef:
    name: "oci-vault"
    kind: "ClusterSecretStore"
  # OCI staging refresh - check every 10 minutes
  refreshInterval: "10m"
  retrySettings:
    maxRetries: 8
    retryInterval: "15s"
    retryIntervalMax: "10m"
  # Consolidated OCI Vault secret name (matches Terraform application_secrets key)
  # All Flask secrets in one vault secret: flask-app
  appSecretKey: "flask-app"

# ------------------------------------------------------------------------------
# Ingress Configuration
# ------------------------------------------------------------------------------
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
  hosts:
    # UPDATE: Set your actual domain
    - host: "api.adaas-il.com"
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: "flask-api-tls"
      hosts:
        - "api.adaas-il.com"

# ------------------------------------------------------------------------------
# JWT Configuration
# ------------------------------------------------------------------------------
jwt:
  enabled: true
  algorithm: RS256
  # UPDATE: Set your actual domain
  issuer: "https://api.adaas-il.com"
  audience: "flask-backend"
  existingSecret: "flask-app-jwt-keys"
  privateKeyKey: "JWT_PRIVATE_KEY"
  publicKeyKey: "JWT_PUBLIC_KEY"
  createSecret: false

# ------------------------------------------------------------------------------
# OIDC/Keycloak Integration
# ------------------------------------------------------------------------------
oidc:
  enabled: true
  # UPDATE: Set your actual domain
  issuer: "https://keycloak.adaas-il.com/realms/platform"
  clientId: "flask-backend"
  scopes: "openid profile email groups"
  audience: "flask-backend"
  algorithms: ["RS256"]
  groupsClaim: "groups"
  roleMapping:
    "/platform-admins": "admin"
    "/developers": "developer"
  existingSecret: "flask-app-oidc"

# ------------------------------------------------------------------------------
# Rotation Configuration
# ------------------------------------------------------------------------------
rotation:
  jwt:
    enabled: true
    schedule: "0 2 * * 0"  # Weekly on Sunday at 2 AM
    gracePeriodDays: 7
    retention: 2
    serviceAccount:
      create: true
      name: "flask-app-jwt-rotator"
      annotations: {}  # Add OCI workload identity annotation if needed
  database:
    enabled: true
    schedule: "0 3 1 * *"  # Monthly on 1st day at 3 AM
    gracePeriodDays: 30
    retention: 2
    batchSize: 100
    keyVersions: ["v1"]
    serviceAccount:
      create: true
      name: "flask-app-db-key-rotator"
      annotations: {}
  reloader:
    enabled: true
    autoRestart: true

# ------------------------------------------------------------------------------
# Monitoring
# ------------------------------------------------------------------------------
monitoring:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 15s
    scrapeTimeout: 10s
    labels:
      release: prometheus
  prometheusRule:
    enabled: true
    labels:
      release: prometheus

# ------------------------------------------------------------------------------
# Resources - Sized for OCI Always-Free tier
# ------------------------------------------------------------------------------
resources:
  requests:
    cpu: 200m
    memory: 384Mi
  limits:
    cpu: 500m
    memory: 768Mi

# ------------------------------------------------------------------------------
# Pod Security
# ------------------------------------------------------------------------------
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  fsGroupChangePolicy: "OnRootMismatch"

securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
