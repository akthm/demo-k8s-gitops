# ==============================================================================
# Monitoring Stack - OCI Production
# ==============================================================================
# TODO: Update domain, vault secrets, and storage class for production.
# ==============================================================================

kubePrometheusStack:
  enabled: true
  namespace: monitoring
  version: "55.5.0"

  prometheus:
    retention: 30d
    scrapeInterval: 30s
    scrapeTimeout: 10s
    evaluationInterval: 30s

    storage:
      enabled: true
      size: 50Gi
      storageClassName: oci-bv-paravirtualized

    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: 1000m
        memory: 2Gi

    serviceMonitorSelector:
      matchLabels:
        release: prometheus

    ruleSelector:
      matchLabels:
        release: prometheus

    externalLabels:
      cluster: oci-production
      environment: production

  grafana:
    enabled: true
    adminPassword: ""

    persistence:
      enabled: true
      size: 10Gi
      storageClassName: oci-bv-paravirtualized

    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi

    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: "1"
        searchNamespace: ALL

    envValueFrom:
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
        secretKeyRef:
          name: grafana-oauth-secret
          key: GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET

    "grafana.ini":
      server:
        domain: grafana.adaas-il.com  # TODO: Update for production domain
        root_url: "https://grafana.adaas-il.com"

      auth:
        disable_login_form: false

      "auth.generic_oauth":
        enabled: true
        name: Keycloak
        allow_sign_up: true
        auto_login: false
        client_id: grafana
        scopes: "openid profile email groups"
        auth_url: https://keycloak.adaas-il.com/realms/master/protocol/openid-connect/auth
        token_url: https://keycloak.adaas-il.com/realms/master/protocol/openid-connect/token
        api_url: https://keycloak.adaas-il.com/realms/master/protocol/openid-connect/userinfo
        role_attribute_path: "contains(groups[*], 'platform-developers') && 'Admin' || contains(groups[*], 'monitoring-viewers') && 'Viewer' || 'Viewer'"
        role_attribute_strict: false
        groups_attribute_path: groups
        use_pkce: true
        empty_scopes: false

    datasources:
      loki:
        enabled: false
