# Staging environment - Enable full monitoring stack

kubePrometheusStack:
  enabled: true  # Enable Prometheus Operator in staging
  
  prometheus:
    retention: 15d
    scrapeInterval: 30s  # 30s scrape for staging
    
    storage:
      enabled: true
      size: 50Gi
    
    externalLabels:
      cluster: staging-k8s
      environment: staging
    
    # External URL for Prometheus (subdomain routing)
    externalUrl: "https://prometheus.staging.local"
    routePrefix: /
  
  grafana:
    enabled: true
    adminPassword: "changeme-staging"  # TODO: Move to External Secret
    persistence:
      enabled: true
      size: 10Gi
    
    # Grafana server configuration for subdomain routing
    grafana.ini:
      server:
        domain: grafana.staging.local
        root_url: "https://grafana.staging.local"
        # No serve_from_sub_path needed - running at root
      # ==============================================================================
      # Keycloak OAuth Configuration (Subdomain URLs)
      # ==============================================================================
      auth.generic_oauth:
        enabled: true
        name: "Keycloak"
        allow_sign_up: true
        client_id: "grafana"
        # client_secret loaded from environment
        scopes: "openid profile email groups"
        auth_url: "https://keycloak.staging.local/realms/platform/protocol/openid-connect/auth"
        token_url: "https://keycloak.staging.local/realms/platform/protocol/openid-connect/token"
        api_url: "https://keycloak.staging.local/realms/platform/protocol/openid-connect/userinfo"
        role_attribute_path: "contains(groups[*], '/grafana-admins') && 'Admin' || contains(groups[*], '/grafana-editors') && 'Editor' || 'Viewer'"
        role_attribute_strict: false
        groups_attribute_path: "groups"
        # Use HTTPS for callback
        use_pkce: true
    
    # Load client secret from environment
    envFromSecret: grafana-oauth-secret
    
    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: "1"
        searchNamespace: ALL  # Discover dashboards in all namespaces

# Enable External Secrets Operator monitoring in staging
externalSecretsOperator:
  monitoring:
    enabled: false  # TEMPORARILY DISABLED - Enable after kube-prometheus-stack installs CRDs

# Loki Stack - Phase 2 (disabled for now)
lokiStack:
  enabled: false  # Enable in Phase 2 for log aggregation
