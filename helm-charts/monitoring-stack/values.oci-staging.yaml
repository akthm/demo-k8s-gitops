# ==============================================================================
# Monitoring Stack - OCI Staging Environment
# ==============================================================================
# Configuration for OCI deployment with:
#   - Prometheus + Grafana via kube-prometheus-stack
#   - OCI Block Volume storage (oci-bv storage class)
#   - Secrets rotation dashboards
#   - Let's Encrypt TLS
# ==============================================================================

# ------------------------------------------------------------------------------
# Kube Prometheus Stack - MUST be enabled for CRDs
# ------------------------------------------------------------------------------
kubePrometheusStack:
  enabled: true  # Enable Prometheus Operator to install CRDs
  namespace: monitoring
  version: "55.5.0"
  
  prometheus:
    retention: 15d
    scrapeInterval: 30s
    scrapeTimeout: 10s
    evaluationInterval: 30s
    
    storage:
      enabled: true
      size: 20Gi
      storageClassName: oci-bv-paravirtualized
    
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    
    # ServiceMonitor selector - match app ServiceMonitors
    serviceMonitorSelector:
      matchLabels:
        release: prometheus
    
    # PrometheusRule selector - match app PrometheusRules
    ruleSelector:
      matchLabels:
        release: prometheus
    
    externalLabels:
      cluster: oci-staging
      environment: staging
  
  grafana:
    enabled: true
    adminPassword: ""  # Use external secret
    
    persistence:
      enabled: true
      size: 10Gi
      storageClassName: oci-bv-paravirtualized
    
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 300m
        memory: 512Mi
    
    # Auto-discover dashboards from ConfigMaps
    sidecar:
      dashboards:
        enabled: true
        label: grafana_dashboard
        labelValue: "1"
        searchNamespace: ALL
    
    # Grafana server configuration
    grafana.ini:
      server:
        domain: grafana.adaas-il.com
        root_url: "https://grafana.adaas-il.com"
      auth.generic_oauth:
        enabled: true
        name: Keycloak
        allow_sign_up: true
        client_id: grafana
        scopes: openid profile email groups
        auth_url: https://keycloak.adaas-il.com/realms/master/protocol/openid-connect/auth
        token_url: https://keycloak.adaas-il.com/realms/master/protocol/openid-connect/token
        api_url: https://keycloak.adaas-il.com/realms/master/protocol/openid-connect/userinfo
        role_attribute_path: "contains(groups[*], '/grafana-admins') && 'Admin' || contains(groups[*], '/grafana-editors') && 'Editor' || 'Viewer'"
        use_pkce: true
    
    # Load client secret from environment
    envFromSecret: grafana-oauth-secret
    
    datasources:
      loki:
        enabled: false  # Enable when Loki is deployed

# ------------------------------------------------------------------------------
# External Secrets Operator Monitoring
# ------------------------------------------------------------------------------
externalSecretsOperator:
  monitoring:
    enabled: false  # Enable after kube-prometheus-stack installs CRDs

# ------------------------------------------------------------------------------
# External Secrets - OCI Vault
# ------------------------------------------------------------------------------
externalSecrets:
  enabled: true
  secretStore:
    name: oci-vault
    kind: ClusterSecretStore
  appSecretKey: "monitoring"

# ------------------------------------------------------------------------------
# Loki Stack - Phase 2
# ------------------------------------------------------------------------------
lokiStack:
  enabled: false
