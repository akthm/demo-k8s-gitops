{{- if .Values.ingress.enabled }}
# ==============================================================================
# Platform App Ingress - Simplified BFF Architecture
# ==============================================================================
# Uses nginx-ingress auth annotations instead of nginx-gateway.
# - /api/* routes to backend with authentication enforced at ingress level
# - /oauth2/* routes to oauth2-proxy (no auth required - it handles auth)
# - /* routes to frontend (no auth - frontend handles auth client-side)
# ==============================================================================

---
# API Ingress - Protected by oauth2-proxy auth
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "platform-app.fullname" . }}-api
  labels:
    {{- include "platform-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: api-ingress
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # Auth annotations - use oauth2-proxy for authentication
    nginx.ingress.kubernetes.io/auth-url: "http://{{ include "platform-app.fullname" . }}-oauth2-proxy.{{ .Release.Namespace }}.svc.cluster.local:4180/oauth2/auth"
    nginx.ingress.kubernetes.io/auth-signin: "https://{{ .Values.global.domain }}/oauth2/start?rd=$escaped_request_uri"
    {{- if .Values.ingress.apiAuthResponseHeaders }}
    nginx.ingress.kubernetes.io/auth-response-headers: {{ join "," .Values.ingress.apiAuthResponseHeaders | quote }}
    {{- else }}
    nginx.ingress.kubernetes.io/auth-response-headers: "X-Auth-Request-User,X-Auth-Request-Email,X-Auth-Request-Preferred-Username,X-Auth-Request-Groups,X-Auth-Request-Access-Token"
    {{- end }}
    # Rate limiting for API
    nginx.ingress.kubernetes.io/limit-rps: "{{ .Values.ingress.apiRateLimit | default 10 }}"
    nginx.ingress.kubernetes.io/limit-connections: "50"
    # Proxy settings
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if or .Values.ingress.tls .Values.global.tls.enabled }}
  tls:
    {{- if .Values.ingress.tls }}
    {{- toYaml .Values.ingress.tls | nindent 4 }}
    {{- else }}
    - secretName: {{ .Values.global.tls.secretName }}
      hosts:
        - {{ .Values.global.domain }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ .Values.global.domain | quote }}
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: {{ .Release.Name }}-backend
                port:
                  number: {{ .Values.backend.service.port }}

---
# OAuth2 Proxy Ingress - Handles auth flow (no auth_request on this path)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "platform-app.fullname" . }}-oauth2
  labels:
    {{- include "platform-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: oauth2-ingress
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # No auth-url here - oauth2-proxy handles its own auth
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if or .Values.ingress.tls .Values.global.tls.enabled }}
  tls:
    {{- if .Values.ingress.tls }}
    {{- toYaml .Values.ingress.tls | nindent 4 }}
    {{- else }}
    - secretName: {{ .Values.global.tls.secretName }}
      hosts:
        - {{ .Values.global.domain }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ .Values.global.domain | quote }}
      http:
        paths:
          - path: /oauth2
            pathType: Prefix
            backend:
              service:
                name: {{ include "platform-app.fullname" . }}-oauth2-proxy
                port:
                  number: 4180

---
# BFF Auth Endpoints - Maps /auth/* to oauth2-proxy endpoints
# This provides friendly URLs for the frontend SPA
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "platform-app.fullname" . }}-auth-login
  labels:
    {{- include "platform-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: auth-ingress
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # Rewrite /auth/login to /oauth2/start
    nginx.ingress.kubernetes.io/rewrite-target: /oauth2/start
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if or .Values.ingress.tls .Values.global.tls.enabled }}
  tls:
    {{- if .Values.ingress.tls }}
    {{- toYaml .Values.ingress.tls | nindent 4 }}
    {{- else }}
    - secretName: {{ .Values.global.tls.secretName }}
      hosts:
        - {{ .Values.global.domain }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ .Values.global.domain | quote }}
      http:
        paths:
          - path: /auth/login
            pathType: Exact
            backend:
              service:
                name: {{ include "platform-app.fullname" . }}-oauth2-proxy
                port:
                  number: 4180

---
# /auth/logout -> /oauth2/sign_out
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "platform-app.fullname" . }}-auth-logout
  labels:
    {{- include "platform-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: auth-ingress
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    nginx.ingress.kubernetes.io/rewrite-target: /oauth2/sign_out
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if or .Values.ingress.tls .Values.global.tls.enabled }}
  tls:
    {{- if .Values.ingress.tls }}
    {{- toYaml .Values.ingress.tls | nindent 4 }}
    {{- else }}
    - secretName: {{ .Values.global.tls.secretName }}
      hosts:
        - {{ .Values.global.domain }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ .Values.global.domain | quote }}
      http:
        paths:
          - path: /auth/logout
            pathType: Exact
            backend:
              service:
                name: {{ include "platform-app.fullname" . }}-oauth2-proxy
                port:
                  number: 4180

---
# /auth/userinfo -> /oauth2/userinfo
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "platform-app.fullname" . }}-auth-userinfo
  labels:
    {{- include "platform-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: auth-ingress
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    nginx.ingress.kubernetes.io/rewrite-target: /oauth2/userinfo
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if or .Values.ingress.tls .Values.global.tls.enabled }}
  tls:
    {{- if .Values.ingress.tls }}
    {{- toYaml .Values.ingress.tls | nindent 4 }}
    {{- else }}
    - secretName: {{ .Values.global.tls.secretName }}
      hosts:
        - {{ .Values.global.domain }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ .Values.global.domain | quote }}
      http:
        paths:
          - path: /auth/userinfo
            pathType: Exact
            backend:
              service:
                name: {{ include "platform-app.fullname" . }}-oauth2-proxy
                port:
                  number: 4180

---
# Frontend Ingress - No auth (SPA handles auth state client-side)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "platform-app.fullname" . }}-frontend
  labels:
    {{- include "platform-app.labels" . | nindent 4 }}
    app.kubernetes.io/component: frontend-ingress
  annotations:
    {{- with .Values.ingress.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    # No auth-url here - frontend is public, handles auth client-side
spec:
  {{- if .Values.ingress.className }}
  ingressClassName: {{ .Values.ingress.className }}
  {{- end }}
  {{- if or .Values.ingress.tls .Values.global.tls.enabled }}
  tls:
    {{- if .Values.ingress.tls }}
    {{- toYaml .Values.ingress.tls | nindent 4 }}
    {{- else }}
    - secretName: {{ .Values.global.tls.secretName }}
      hosts:
        - {{ .Values.global.domain }}
    {{- end }}
  {{- end }}
  rules:
    - host: {{ .Values.global.domain | quote }}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ .Release.Name }}-frontend
                port:
                  number: {{ .Values.frontend.service.port }}
{{- end }}
