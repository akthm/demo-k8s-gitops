# ==============================================================================
# Platform App - Production Environment Values
# ==============================================================================
# This configuration is for production environment
# - TLS enabled via cert-manager (Let's Encrypt production)
# - External secrets from AWS Secrets Manager
# - High availability with multiple replicas
# - Strict security policies
# - External Redis (ElastiCache)
# ==============================================================================

global:
  domain: "platform.example.com"
  namespace: "platform"
  environment: "production"
  
  tls:
    enabled: true
    secretName: "platform-prod-tls"
  
  keycloak:
    enabled: true
    url: "https://keycloak.example.com"
    realm: "platform"
    bffClientId: "bff-proxy"
    bffClientSecretRef:
      name: ""  # Uses ExternalSecret
      key: "client-secret"
    publicClientId: "react-frontend"
    backendClientId: "flask-backend"
    backendClientSecretRef:
      name: ""
      key: "client-secret"
    scopes: "openid profile email groups"
  
  bff:
    enabled: true
    internalSecretRef:
      name: ""  # Uses ExternalSecret
      key: "internal-secret"
    cookie:
      name: "__Host-bff-session"
      secure: true
      httpOnly: true
      sameSite: "Strict"  # Stricter for production
      expire: "168h"
    redis:
      enabled: true
      external:
        enabled: true
        url: "rediss://platform-redis.xxxxx.cache.amazonaws.com:6379"
  
  externalSecrets:
    enabled: true
    secretStoreRef:
      name: "aws-secrets-manager"
      kind: "ClusterSecretStore"
    refreshInterval: "15m"  # Less frequent in prod
    basePath: "production/platform"

# OAuth2 Proxy
oauth2Proxy:
  enabled: true
  replicaCount: 3
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 60
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/component: oauth2-proxy
          topologyKey: kubernetes.io/hostname

# Backend
backend:
  enabled: true
  replicaCount: 3
  
  image:
    repository: akthm/demo-back
    tag: "1.0.14"
    pullPolicy: IfNotPresent
  
  config:
    DEBUG: "0"
    AUTH_MODE: "bff"
    CORS_ORIGINS: "https://platform.example.com"
    GUNICORN_WORKERS: "1" ## NEVER set this >1 in production with BFF auth mode, as it will break session handling without sticky sessions
  
  oidc:
    enabled: true
    issuer: "https://keycloak.example.com/realms/platform"
  
  bff:
    enabled: true
    validateJwt: true
    jitProvision: true
    rolesSource: "jwt"
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 60
  
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  # Use MySQL database with replication
  db:
    enabled: true
    architecture: replication
    auth:
      existingSecret: "flask-app-db"
      database: flask_db
      username: flask_user
    primary:
      persistence:
        enabled: true
        size: 20Gi
    secondary:
      replicaCount: 2
      persistence:
        enabled: true
        size: 20Gi
  
  externalSecrets:
    enabled: true
    databaseKey: "production/backend/database"
    flaskAppKey: "production/backend/flask-app"
    adminKey: "production/backend/admin"
    jwtKeysKey: "production/backend/jwt-keys"
    oidcKey: "production/backend/oidc"
  
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
    prometheusRule:
      enabled: true

# Frontend
frontend:
  enabled: true
  replicaCount: 3
  
  image:
    repository: akthm/demo-front
    tag: "1.0.3"
    pullPolicy: IfNotPresent
  
  backend:
    enabled: false
  
  bff:
    enabled: true
  
  keycloak:
    enabled: false
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 60
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# Redis - using external ElastiCache
redis:
  enabled: false  # Using external Redis

# Nginx Gateway
nginxGateway:
  enabled: true
  replicaCount: 3
  
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPUUtilizationPercentage: 60
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi
  
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/component: nginx-gateway
          topologyKey: kubernetes.io/hostname

# Ingress
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "Strict-Transport-Security: max-age=31536000; includeSubDomains; preload";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
      more_set_headers "Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://keycloak.example.com; frame-ancestors 'none';";
  hosts:
    - host: "platform.example.com"
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: platform-prod-tls
      hosts:
        - platform.example.com

# Network policies enabled with strict rules
networkPolicy:
  enabled: true
  ingressController:
    namespaceSelector:
      matchLabels:
        kubernetes.io/metadata.name: ingress-nginx
  monitoring:
    enabled: true
    namespaceSelector:
      matchLabels:
        kubernetes.io/metadata.name: monitoring

# Service account with IRSA
serviceAccount:
  create: true
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::ACCOUNT_ID:role/platform-prod-role"

# PDB enabled with higher availability
podDisruptionBudget:
  enabled: true
  minAvailable: 2
