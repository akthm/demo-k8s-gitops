# ==============================================================================
# Platform App - OCI Production Environment
# ==============================================================================
# Production configuration for Oracle Cloud Infrastructure (OCI) with:
#   - BFF (Backend-for-Frontend) pattern with oauth2-proxy
#   - OCI Autonomous Database (ATP) with wallet-based mTLS
#   - OCI Vault for secrets management (via External Secrets Operator)
#   - High availability configuration
#   - Let's Encrypt TLS via Cloudflare DNS01
# ==============================================================================

# ==============================================================================
# Global Configuration
# ==============================================================================
global:
  # OCI-specific image registry
  imageRegistry: "docker.io"
  
  # OCI production environment
  environment: "oci-production"
  
  # Security settings
  security:
    allowInsecureImages: true
  
  # UPDATE: Set your actual production domain
  domain: "adaas-il.com"
  
  # Keycloak SSO Configuration
  keycloak:
    # UPDATE: Set your actual domain
    url: "https://keycloak.adaas-il.com"
    realm: "platform"
    adminUrl: "https://keycloak.adaas-il.com"
  
  # BFF Pattern Configuration
  bff:
    enabled: true
    cookieDomain: ".adaas-il.com"
    cookieSecure: true
    sessionTTL: "4h"  # Shorter sessions for production
  
  # External Secrets Configuration - OCI Vault
  externalSecrets:
    enabled: true
    secretStore:
      name: "oci-vault"
      kind: "ClusterSecretStore"
    refreshInterval: "15m"  # Less frequent for production
    retrySettings:
      maxRetries: 10
      retryInterval: "30s"
      retryIntervalMax: "15m"

# ==============================================================================
# OAuth2 Proxy Configuration
# ==============================================================================
oauth2Proxy:
  enabled: true
  
  replicaCount: 3  # Higher replica count for production
  
  image:
    repository: quay.io/oauth2-proxy/oauth2-proxy
    tag: "v7.6.0"
  
  # Autoscaling for production
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 60
  
  config:
    provider: "oidc"
    # UPDATE: Set your actual domain
    oidcIssuerUrl: "https://keycloak.adaas-il.com/realms/master"
    clientId: "platform-bff"
    scope: "openid profile email groups"
    emailDomains:
      - "*"
    passAccessToken: true
    passAuthorizationHeader: true
    setXAuthRequest: true
    setAuthorizationHeader: true
    passUserHeaders: true
    
    # Cookie configuration - more restrictive for production
    cookieName: "__Host-oauth2_proxy"
    cookieSecure: true
    cookieDomain: ""  # Let browser scope to current domain
    cookieSameSite: "strict"
    cookieExpire: "4h"
    cookieRefresh: "15m"
    
    sessionStoreType: "redis"
    skipProviderButton: true
    proxyPrefix: "/oauth2"
  
  externalSecret:
    enabled: true
    secretStoreRef:
      name: "oci-vault"
      kind: "ClusterSecretStore"
    refreshInterval: "15m"
    remoteRef:
      key: "platform-bff-prod"
      property: ""
    dataMapping:
      clientSecret: "client-secret"
      cookieSecret: "cookie-secret"
  
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  # Production HA settings
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: oauth2-proxy
          topologyKey: kubernetes.io/hostname
  
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: oauth2-proxy

# ==============================================================================
# Nginx Gateway (BFF Routing)
# ==============================================================================
nginxGateway:
  enabled: true
  
  replicaCount: 3
  
  image:
    repository: nginx
    tag: "1.27-alpine"
  
  service:
    type: ClusterIP
    port: 80
  
  # Stricter rate limiting for production
  rateLimit:
    enabled: true
    requestsPerSecond: "100r/s"
    burst: 200
    nodelay: true
  
  csrf:
    enabled: true
    cookieName: "XSRF-TOKEN"
    headerName: "X-CSRF-Token"
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 300m
      memory: 256Mi

# ==============================================================================
# Redis Session Storage
# ==============================================================================
redis:
  enabled: true
  architecture: replication  # HA for production
  
  auth:
    enabled: true
    existingSecret: ""
  
  replica:
    replicaCount: 2
  
  master:
    persistence:
      enabled: true
      size: 2Gi
      storageClass: ""
    
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  
  sentinel:
    enabled: true
    masterSet: mymaster
    quorum: 2
  
  commonConfiguration: |-
    maxmemory 400mb
    maxmemory-policy allkeys-lru
    timeout 300
    tcp-keepalive 60
    appendonly yes
    appendfsync everysec

# ==============================================================================
# Backend (Flask App) Configuration
# ==============================================================================
backend:
  enabled: true
  
  replicaCount: 3
  
  # Image version controlled by flask-app/values.yaml - updated by CI/CD
  # image:
  #   repository: "docker.io/akthm/demo-back"
  #   tag: "1.1.3"
  #   pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 5000
    targetPort: 5000
  
  # Autoscaling for production
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  # Disable in-cluster MySQL - Using OCI ATP
  db:
    enabled: false
  
  # Oracle ATP Database Wallet Configuration
  database:
    wallet:
      enabled: true
      tnsAlias: "proddb_high"
      refreshInterval: "24h"
  
  # External Secrets - OCI Vault
  externalSecrets:
    enabled: true
    secretStoreRef:
      name: "oci-vault"
      kind: "ClusterSecretStore"
    refreshInterval: "15m"
    retrySettings:
      maxRetries: 10
      retryInterval: "30s"
      retryIntervalMax: "15m"
    appSecretKey: "flask-app-prod"
  
  config:
    DEBUG: "0"
    DOCKERIZED: "true"
    GUNICORN_WORKERS: "1" ## NEVER INCREASE causes DB race conditions with OCI ATP - use autoscaling instead
    BACKEND_PORT: "5000"
    # UPDATE: Set your actual domain
    CORS_ORIGINS: "https://app.adaas-il.com,https://adaas-il.com"
    # SQLALCHEMY_TRACK_MODIFICATIONS: "False"
    # JWT_ACCESS_TTL: "600"  # Shorter for production
    # JWT_REFRESH_TTL: "2592000"
    # JWT_COOKIE_NAME: "rt"
    # JWT_CSRF_COOKIE: "csrf_refresh_root"
    # JWT_COOKIE_SECURE: "true"
    # JWT_COOKIE_SAMESITE: "Strict"  # Stricter for production
    # JWT_COOKIE_DOMAIN: ""
    # JWT_LEEWAY: "30"
    API_TEST_MODE: "false"
    DB_FALLBACK_TO_SQLITE_IN_MEMORY: "false"
    DB_TYPE: "postgresql"
    DB_ENCRYPTION_ENABLED: "true"
    DB_ENCRYPTION_ALGORITHM: "FERNET"
    DB_ENCRYPTION_KEY_ROTATION_GRACE_PERIOD: "86400"
    DATABASE_ENCRYPTION_KEYS_DIR: "/run/secrets/db_encryption_keys"
    DB_ENCRYPTED_FIELDS: "email,phone,medical_notes,patient_name"
    # BFF Mode
    AUTH_MODE: "bff"
    BFF_INTERNAL_SECRET_HEADER: "X-Internal-Auth"
    BFF_HEADER_SUB: "X-Auth-Request-User"
    BFF_HEADER_EMAIL: "X-Auth-Request-Email"
    BFF_HEADER_USERNAME: "X-Auth-Request-Preferred-Username"
    BFF_HEADER_GROUPS: "X-Auth-Request-Groups"
    BFF_TOKEN_HEADER: "X-Forwarded-Access-Token"
    BFF_VALIDATE_JWT: "true"
    BFF_JIT_PROVISION: "true"
    BFF_ROLES_SOURCE: "jwt"
    CSRF_ENABLED: "true"
    CSRF_COOKIE_NAME: "XSRF-TOKEN"
    CSRF_HEADER_NAME: "X-CSRF-Token"
  
  oidc:
    enabled: true
    # UPDATE: Set your actual domain
    issuer: "https://keycloak.adaas-il.com/realms/platform"
    clientId: "flask-backend"
    scopes: "openid profile email groups"
    audience: "flask-backend"
    algorithms: ["RS256"]
    groupsClaim: "groups"
    roleMapping:
      "/platform-admins": "admin"
      "/developers": "developer"
    existingSecret: "flask-app-oidc-prod"
  
  jwt:
    enabled: true
    algorithm: RS256
    # UPDATE: Set your actual domain
    issuer: "https://api.adaas-il.com"
    audience: "flask-backend"
    existingSecret: "flask-app-jwt-keys-prod"
    privateKeyKey: "JWT_PRIVATE_KEY"
    publicKeyKey: "JWT_PUBLIC_KEY"
    createSecret: false
  
  rotation:
    jwt:
      enabled: true
      schedule: "0 2 * * 0"
      gracePeriodDays: 7
      retention: 2
      serviceAccount:
        create: true
        name: "flask-app-jwt-rotator"
    database:
      enabled: true
      schedule: "0 3 1 * *"
      gracePeriodDays: 30
      retention: 2
      batchSize: 100
      keyVersions: ["v1"]
      serviceAccount:
        create: true
        name: "flask-app-db-key-rotator"
    reloader:
      enabled: true
      autoRestart: true
  
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 15s
      labels:
        release: prometheus
    prometheusRule:
      enabled: true
      labels:
        release: prometheus
  
  resources:
    requests:
      cpu: 300m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    fsGroupChangePolicy: "OnRootMismatch"
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false

# ==============================================================================
# Frontend (Nginx) Configuration
# ==============================================================================
frontend:
  enabled: true
  
  replicaCount: 3
  
  image:
    repository: "docker.io/akthm/demo-front"
    tag: "1.0.3"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 8080
  
  keycloak:
    enabled: false
  
  backend:
    enabled: false
  
  bff:
    enabled: true
    runtimeConfig:
      authMode: "bff"
      # UPDATE: Set your actual domain
      apiBaseUrl: "https://app.adaas-il.com/api"
      csrfEnabled: true
      csrfCookieName: "XSRF-TOKEN"
      csrfHeaderName: "X-CSRF-Token"
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 300m
      memory: 256Mi

# ==============================================================================
# Ingress Configuration
# ==============================================================================
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/limit-rps: "200"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-Frame-Options: DENY";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
  # UPDATE: Set your actual domain
  hosts:
    - host: "app.adaas-il.com"
      paths:
        - path: /
          pathType: Prefix
          service: frontend
        - path: /api
          pathType: Prefix
          service: backend
        - path: /oauth2
          pathType: Prefix
          service: oauth2-proxy
  tls:
    - secretName: "platform-app-prod-tls"
      hosts:
        - "app.adaas-il.com"

# ==============================================================================
# Network Policies
# ==============================================================================
networkPolicy:
  enabled: true
  allowIngressFrom:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: ingress-nginx
  allowMonitoringFrom:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring

# ==============================================================================
# Service Account
# ==============================================================================
serviceAccount:
  create: true
  annotations:
    # Add OCI workload identity annotation for production
    # oci.oraclecloud.com/workload-identity-principal: "<OCID>"
  name: ""

# ==============================================================================
# Pod Disruption Budget
# ==============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 2  # Higher for production

# ==============================================================================
# Horizontal Pod Autoscaler
# ==============================================================================
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 12
  targetCPUUtilizationPercentage: 60
  targetMemoryUtilizationPercentage: 75
